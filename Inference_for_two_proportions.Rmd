---
title: "Inference for two proportions"
author: "Put your name here"
date: "Put the date here"
output: pdf_document
---
<!-- Please don't mess with the next two lines! -->
\newenvironment{answer}{\definecolor{shadecolor}{RGB}{225, 225, 255}\begin{shaded}}{\end{shaded}}
<!-- Please don't mess with the previous two lines! -->


## Introduction

In this assignment we will learn how to run hypothesis tests for categorical data in R.

If we have one categorical variable with two categories (a "success" condition and a "failure" condition), we will run a test for a single proportion. In the presence of another categorical explanatory variable with two categories that we want to compare, we will run a test for the difference between two proportions.

Things change a little when there are three or more categories. In this case we run a chi-square goodness-of-fit test for one categorical variables and a chi-square test of independence for two categorical variables.


## Instructions

Presumably, you have already created a new project and downloaded this file into it. Please knit the document and work back and forth between this R Markdown file and the PDF output as you work through this module.

When you are finished with the assignment, knit to PDF one last time, proofread the PDF file **carefully**, export the PDF file to your computer, and then submit your assignment.

Sometimes you will be asked to add your own R code. That will appear in this document as a code chunk with a request for you to add your own code, like so:

```{r}
## Add code here to [do some task]...
```

Be sure to remove the line `## Add code here to [do some task]...` when you have added your own code.

Sometimes you will be asked to type up your thoughts. That will appear in the document as follows:

\begin{answer}
Please write up your answer here.
\end{answer}

Again, please be sure to remove the line "Please write up your answer here" when you have written up your answer. In these areas of the assignment, please use contextually meaningful full sentences/paragraphs (unless otherwise indicated) and proper spelling, grammar, punctuation, etc. This is not R code, but rather a free response section where you talk about your analysis and conclusions. If you need to use some R code as well, you can use inline R code inside the block between `\begin{answer}` and `\end{answer}`, or if you need an R code chunk, please go outside the `answer` block and start a new code chunk.


## Load Packages

We load the standard `mosaic` package as well as the `MASS` package.

```{r, message = FALSE, warning = FALSE}
library(mosaic)
library(MASS)
```


## Inference for two proportions

Suppose we are interested in learning about the gender distribution among the patients who had died from melanoma at the time the Danish study was published. In this case, we are thinking of `sex` as the explanatory variable and `status` as the response variable.

As `status` is a variable we have not yet considered, let's take a look at it:

```{r}
table(Melanoma$status)
```

You'll note that there are three categories here. However, we are going to take "died from melanoma" as the "success" category and everything else as a failure. We will re-code our data, not just to replace the numbers with words, but also to consolidate three categories into two.

```{r}
status <- factor(Melanoma$status,
                 levels = c(1, 2, 3))
levels(status) <- c("Died from melanoma", "Other", "Other")
table(status)
```

Now let's look at the two variables, `sex` and `status` together.

```{r}
CrossTable(sex, status,
           prop.c = FALSE,  prop.t = FALSE, prop.chisq = FALSE)
```

So the question is, among Danish patients with malignant melanoma, are men or women more like to die from the disease?

It will be helpful for us in the work below to extract all the counts we need and assign them to variables. Fortunately for us, the `CrossTable` command gives us a way to access all the numbers in the contingency table. So first, we'll give the contingency table a name:

```{r}
sex_status <- CrossTable(sex, status,
                         prop.c = FALSE,  prop.t = FALSE, prop.chisq = FALSE)
```

Then we'll grab the stuff we need:

```{r}
male_dead <- sex_status$t["male", "Died from melanoma"]
female_dead <- sex_status$t["female", "Died from melanoma"]
male_other <- sex_status$t["male", "Other"]
female_other <- sex_status$t["female", "Other"]
n_M <- male_dead + male_other
n_F <- female_dead + female_other
```
    
## Hypotheses

### Identify the sample and a reasonable population of interest.

There are two samples: `r n_M` male patients and `r n_F` female patients in Denmark with malignant melanoma. In order for these samples to be representative of their respective populations, we should probably restrict our conclusions to the population of all males and females in Denmark with malignant melanoma.

### Express the null and alternative hypotheses as contextually meaningful full sentences.

$H_0:$ There is no difference between the rate at which men and women in Denmark die from malignant melanoma.

$H_A:$ There is a difference between the rate at which men and women in Denmark die from malignant melanoma.


### Express the null and alternative hypotheses in symbols.

$H_0: p_M - p_F = 0$

$H_A: p_M - p_F \neq  0$

## Model

### Identify the correct sampling distribution model.

We will use the normal model.

### Check the relevant conditions to ensure that the model assumptions are met.

* Random
    * We have no information about how this sample was obtained. We hope these 205 patients are representative of other Danish patients with malignant melanoma.
* 10%
    * I don't know exactly how many people in Denmark suffer from malignant melanoma, but I imagine over time it's more than 2000.
* Success/Failure
    * We need to use the pooled proportion of successes to check this. We calculate $\hat{p}_{pooled}$ as shown in class.
    
```{r}
phat_pooled <- (male_dead + female_dead)/(n_M + n_F)
```

Here are the success/failure computations:

$n_M \hat{p}_{pooled}$ = `r n_M * phat_pooled`

$n_M (1 - \hat{p}_{pooled})$ = `r n_M * (1 - phat_pooled)`

$n_F \hat{p}_{pooled}$ = `r n_F * phat_pooled`

$n_F (1 - \hat{p}_{pooled})$ = `r n_F * (1 - phat_pooled)`

## Mechanics

### Compute the test statistic.

We will use the `prop.test` command for this. Now that we are working with two variables, we can use the "formula" notation with the tilde that we have seen before. The only tricky thing to remember is the order of the variables. Remember that the tilde is pronounced "by", so we want to measure "status by sex" or "status grouped by sex".

```{r}
test2 <- prop.test(status ~ sex)
```

As with the single proportion test, the z-score is not part of the output, so we have to compute it directly. Unfortunately, this is much uglier:

```{r}
z <- (test2$estimate[1] - test2$estimate[2])/
    sqrt(phat_pooled * (1 - phat_pooled)/ n_M + 
             phat_pooled * (1 - phat_pooled)/ n_F)
z
```

### Plot the null distribution.

```{r}
pdist(dist = "norm", q = c(-z, z))
```

### Calculate the P-value.

```{r}
test2$p.value
```

If you're paying close attention, you might notice that the P-value above is a little bigger than what you'd get if you doubled the number from the `pdist` command. That's because under the hood `prop.test` is actually running a more sophisticated test. If you add an extra argument to the `prop.test` command, you'll see the "right" P-value:

```{r}
test2_alt <- prop.test(status ~ sex, correct = FALSE)
test2_alt$p.value
```

Of course, which one is actually the "correct" P-value? You have to wonder when you are required to add an argument that literally says `correct = FALSE`! Well, it turns out that "correct" stands for "Yates's Continuity Correction", which most statisticians these days seem not to recommend. It tends to over-inflate the P-value.

### Question: If we use a version of a test that inflates the P-value, which type of error (Type I or Type II) are we more likely to make?

<!-- Please write up your answer in the space below -->


So, the moral of the story here is that we should run our `prop.test` commands with `correct = FALSE`.

## Conclusion

### State the statistical conclusion.

We reject the null hypothesis.

### State (but do not overstate) a contextually meaningful conclusion.

We have sufficient evidence to suggest that there is a difference between the rate at which men and women in Denmark die from malignant melanoma.

### Identify the possibility of either a Type I or Type II error and state what making such an error means in the context of the hypotheses.

If we have made a Type I error, then there would actually be no difference between the rate at which men and women in Denmark die from malignant melanoma, but our samples showed a significant difference.


## Confidence interval

### Conditions

Only the success/failure condition changes. We now need to check the raw counts. We won't reproduce the contingency table here. Just scroll up and check that for both males and females, the counts of those who died and the others are all greater than 10.

### Calculation

As before, we should use the version without the "correction":

```{r}
test2_alt$conf.int
```

### Conclusion

We are 95% confident that the true difference between the rate at which men and women die from malignant melanoma is captured in the interval (`r 100 * test2_alt$conf.int[1]`%, `r 100 * test2_alt$conf.int[2]`%). (This difference is measured by calculating male minus female.)

Note the addition of that last sentence. The rubric specifies that you must indicate the direction of the difference. Without that, we would know that there was a difference, but we would have no idea whether men or women die more from malignant melanoma.


## Now it's your turn!

Go through the rubric to determine if males and females in Denmark who are diagnosed with malignant melanoma suffer from ulcers at different rates.

As before, I'm not going to give you the whole rubric as an outline. Thoughtfully copy and paste from the example above, making the necessary changes as you go along.


